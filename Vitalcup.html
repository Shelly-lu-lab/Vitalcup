<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitalcup 每日蔬果</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@700&family=Montserrat:ital,wght@1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f6fbf7;
      font-family: 'Noto Sans SC', 'Montserrat', Arial, sans-serif;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .navbar {
      width: 100vw;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 18px 0 18px;
      background: transparent;
      box-sizing: border-box;
    }
    .nav-left {
      display: flex;
      align-items: center;
    }
    .logo {
      width: 36px;
      height: 36px;
      margin-right: 10px;
      border-radius: 50%;
      object-fit: cover;
    }
    .title {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .title-cn {
      font-family: 'Noto Sans SC', sans-serif;
      font-size: 1.18rem;
      font-weight: bold;
      color: #222;
      letter-spacing: 1px;
    }
    .title-en {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.86rem;
      color: #222;
      letter-spacing: 1px;
      margin-top: 2px;
      font-style: normal;
    }
    .nav-right {
      display: flex;
      gap: 12px;
    }
    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: #3BA769;
      box-shadow: 0 2px 8px rgba(137,201,151,0.08);
      cursor: pointer;
      transition: background 0.2s;
    }
    .icon-btn:active { background: #eaf6ef; }
    .main-content {
      width: 100vw;
      max-width: 480px;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 8px;
      margin-bottom: 80px;
    }
    .main-title {
      font-size: 1.6rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #222;
      margin-top: 8px;
      margin-bottom: 4px;
      letter-spacing: 2px;
    }
    .main-subtitle {
      font-size: 1.02rem;
      color: #49505a;
      margin-bottom: 18px;
      letter-spacing: 1px;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: 300;
    }
    .juice-card {
      width: 94vw;
      max-width: 420px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 4px 32px rgba(137,201,151,0.10);
      padding: 0 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 18px;
      border: 1.5px solid #e0f2f1;
    }
    .juice-img-wrap {
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0;
      margin-bottom: 18px;
      padding: 0;
    }
    .juice-img-wrap img {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 18px 18px 0 0;
      object-fit: cover;
      background: #f1f8e9;
      border: 3px solid #e0f2f1;
      box-shadow: 0 4px 24px rgba(60,120,80,0.10);
      display: block;
    }
    .img-labels {
      position: absolute;
      top: 10px;
      left: 18px;
      display: flex;
      gap: 8px;
      z-index: 2;
    }
    .date-label, .solar-label {
      font-size: 0.86rem;
      border-radius: 12px;
      padding: 2px 10px;
      box-shadow: 0 2px 8px rgba(137,201,151,0.08);
      font-family: 'Montserrat', 'Noto Sans SC', sans-serif;
      margin-right: 4px;
    }
    .date-label {
      background: rgba(255,255,255,0.82);
      color: #49505a;
      font-style: normal;
      font-weight: normal;
    }
    .solar-label {
      background: rgba(246,190,154,0.82);
      color: #fff;
      font-weight: bold;
    }
    .juice-name-cn {
      font-size: 1.25rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #222;
      margin-top: 2px;
      margin-bottom: 2px;
      letter-spacing: 1px;
      text-align: center;
    }
    .juice-name-en {
      font-size: 1rem;
      color: #49505a;
      font-family: 'Montserrat', sans-serif;
      margin-bottom: 8px;
      text-align: center;
      font-style: italic;
    }
    .ingredients-label {
      font-size: 0.98rem;
      color: #222;
      font-family: 'Noto Sans SC', sans-serif;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      font-weight: bold;
    }
    .icon-leaf {
      font-size: 1.1rem;
      color: #3BA769;
      margin-right: 2px;
    }
    .ingredients-tags {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      margin-bottom: 12px;
      justify-content: center;
      overflow-x: auto;
    }
    .tag {
      background: #eaf6ef;
      color: #3BA769;
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 0.92rem;
      font-family: 'Noto Sans SC', sans-serif;
      letter-spacing: 1px;
      font-weight: bold;
      white-space: nowrap;
    }
    .poem-card {
      background: #f6fbf7;
      border-radius: 14px;
      color: #49505a;
      font-size: 0.96rem;
      font-style: normal;
      font-weight: 300;
      font-family: 'Noto Sans SC', sans-serif;
      margin: 0 18px 0 18px;
      padding: 14px 10px 10px 10px;
      text-align: center;
      line-height: 1.9;
      min-height: 48px;
      opacity: 0.95;
    }
    .footer-bar {
      width: 94vw;
      max-width: 420px;
      margin: 24px auto 0 auto;
      background: #f6fbf7;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px 18px 18px;
      box-sizing: border-box;
      z-index: 10;
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -2px 12px rgba(137,201,151,0.08);
    }
    .main-btn {
      background: #3BA769;
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 10px 38px;
      font-size: 1.15rem;
      font-family: 'Noto Serif SC', serif;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(111,207,151,0.10);
      cursor: pointer;
      transition: background 0.2s;
    }
    .main-btn:active { background: #2e7d4f; }
    .footer-icons {
      display: flex;
      gap: 16px;
    }
    .img-placeholder {
      width: 100%;
      aspect-ratio: 4/3;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: 1.1rem;
      background: #f5f5f5;
      border-radius: 18px 18px 0 0;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
    }
    #auth-modal {
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .auth-mask {
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(240,248,245,0.92);
      z-index: 1;
    }
    .auth-panel {
      position: relative;
      z-index: 2;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(137,201,151,0.13);
      padding: 32px 24px 24px 24px;
      min-width: 280px;
      max-width: 90vw;
      width: 340px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .auth-title {
      font-size: 1.3rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #3BA769;
      margin-bottom: 18px;
    }
    #authForm {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 10px;
    }
    #authForm input {
      font-size: 1rem;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0f2f1;
      outline: none;
      font-family: 'Noto Sans SC', 'Montserrat', Arial, sans-serif;
      background: #f6fbf7;
      color: #222;
      transition: border 0.2s;
    }
    #authForm input:focus {
      border: 1.5px solid #3BA769;
    }
    #authSubmitBtn {
      background: #3BA769;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 0;
      font-size: 1.08rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.2s;
    }
    #authSubmitBtn:active {
      background: #2e7d4f;
    }
    .auth-tip {
      color: #e57373;
      font-size: 0.98rem;
      min-height: 22px;
      margin-bottom: 4px;
      text-align: center;
    }
    .auth-switch {
      font-size: 0.98rem;
      color: #7bbf8e;
      margin-top: 6px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .auth-switch span {
      margin: 0 8px;
      text-decoration: underline;
    }
    @media (max-width: 600px) {
      .main-content, .footer-bar, .navbar { max-width: 100vw; }
      .juice-card { max-width: 99vw; }
    }
    @media (max-width: 480px) {
      .auth-panel { width: 98vw; min-width: 0; padding: 18px 4vw 18px 4vw; }
    }
  </style>
</head>
<body>
  <div id="auth-modal" style="display:none;">
    <div class="auth-mask"></div>
    <div class="auth-panel">
      <div class="auth-title" id="authTitle">邮箱登录</div>
      <form id="authForm" autocomplete="off">
        <input type="email" id="authEmail" placeholder="邮箱地址" required />
        <input type="password" id="authPassword" placeholder="密码" required minlength="6" />
        <button type="submit" id="authSubmitBtn">登录</button>
      </form>
      <div class="auth-tip" id="authTip"></div>
      <div class="auth-switch">
        <span id="switchToRegister">没有账号？注册</span>
        <span id="switchToLogin" style="display:none;">已有账号？登录</span>
      </div>
    </div>
  </div>
  <!-- 顶部导航栏 -->
  <header class="navbar">
    <div class="nav-left">
      <img src="leaf-logo.png" class="logo" alt="logo" />
      <div class="title">
        <span class="title-cn">Vitalcup</span>
        <span class="title-en">每日蔬果</span>
      </div>
    </div>
    <div class="nav-right">
      <button class="icon-btn home" title="主页"><i class="ri-home-4-line"></i></button>
      <button class="icon-btn history" title="历史记录"><i class="ri-time-line"></i></button>
      <button class="icon-btn settings" title="系统设置"><i class="ri-settings-3-line"></i></button>
    </div>
  </header>
  <!-- 主体内容区 -->
  <main class="main-content">
    <div class="main-title">今日推荐</div>
    <div class="main-subtitle">为你精心挑选的纯净蔬果汁</div>
    <div class="juice-card">
      <div class="juice-img-wrap">
        <img id="juiceImgTag" src="vitalcup_20240710_2.jpg" alt="今日蔬果汁" />
        <div id="img-error" class="img-placeholder" style="display:none;">图片加载失败</div>
        <div class="img-labels">
          <span class="date-label" id="dateLabel">2025年7月13日 星期日</span>
          <span class="solar-label" id="solarLabel">小暑</span>
        </div>
      </div>
      <div class="juice-name-cn" id="juiceNameCn">清心露</div>
      <div class="juice-name-en" id="juiceNameEn">Morning Dew</div>
      <div class="ingredients-label"><span class="icon-leaf"><i class="ri-leaf-line"></i></span> 今日配料</div>
      <div class="ingredients-tags" id="ingredientsTags">
        <span class="tag">芒果</span>
        <span class="tag">奇异果</span>
        <span class="tag">黄瓜</span>
        <span class="tag">薄荷叶</span>
      </div>
      <div class="poem-card" id="poemCard">阳光透过玻璃，洒落在新鲜的芒果、奇异果与黄瓜之上，薄荷的清香在空气中轻轻荡漾。每一口，都是夏日清晨的第一缕微风，唤醒身体与心灵的温柔。</div>
    </div>
    <footer class="footer-bar">
      <button class="main-btn" id="changeBtn">换一款</button>
      <div class="footer-icons">
        <button class="icon-btn favorite" id="favoriteBtn" title="收藏"><i class="ri-heart-line"></i></button>
        <button class="icon-btn share" id="shareBtn" title="分享"><i class="ri-share-forward-line"></i></button>
      </div>
    </footer>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase配置
    const SUPABASE_URL = 'https://ypscwsplzpbhevzfuoma.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwc2N3c3BsenBiaGV2emZ1b21hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzg1MjEsImV4cCI6MjA2NzgxNDUyMX0.3i-LYP5N29-QC_i9rw4U0rSkkMulBu8S2RXdLSvRd3g';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
  <script>
    // 你可以在这里适配原有JS逻辑到新结构
    // 下面是主要内容动态填充和按钮事件适配
    // 假设你有AI接口和配料、物语等数据

    // 示例：动态填充内容
    function updateJuiceCard(data) {
      document.getElementById('juiceImgTag').src = data.imgUrl || 'vitalcup_20240710_2.jpg';
      document.getElementById('juiceNameCn').textContent = data.name || '清心露';
      document.getElementById('juiceNameEn').textContent = data.name_en || 'Morning Dew';
      document.getElementById('dateLabel').textContent = data.date || getTodayDateStr();
      document.getElementById('solarLabel').textContent = data.solar_term || '小暑';
      // 配料标签
      const tags = (data.ingredients || '芒果、奇异果、黄瓜、薄荷叶').split(/[、,，\s]+/);
      const tagsHtml = tags.filter(Boolean).map(t => `<span class="tag">${t}</span>`).join('');
      document.getElementById('ingredientsTags').innerHTML = tagsHtml;
      document.getElementById('poemCard').textContent = data.poem || '';
    }

    // 获取今天日期字符串（如：2025年7月13日 星期日）
    function getTodayDateStr() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + 1;
      const d = now.getDate();
      const weekArr = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
      const week = weekArr[now.getDay()];
      return `${y}年${m}月${d}日 ${week}`;
    }
    // 页面加载时自动设置日期
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('dateLabel').textContent = getTodayDateStr();
    });

    // 换一款按钮事件（适配你的AI接口）
    document.getElementById('changeBtn').onclick = async function() {
      this.disabled = true;
      this.textContent = "生成中...";
      const imgEl = document.getElementById("juiceImgTag");
      const imgError = document.getElementById("img-error");
      imgError.style.display = 'none';
      imgEl.style.display = '';
      try {
        // 1. 获取AI生成的蔬果汁内容
        const resp = await fetch('/api/ai-juice');
        const data = await resp.json();
        // 始终用最新的name和name_en渲染
        document.getElementById("juiceNameCn").textContent = data.name || "清心露";
        document.getElementById("juiceNameEn").textContent = data.name_en || "Morning Dew";
        document.getElementById("dateLabel").textContent = data.date || "2025年7月13日 星期日";
        document.getElementById("solarLabel").textContent = data.solar_term || "小暑";
        // 配料标签兼容数组和字符串
        let tags = [];
        if (Array.isArray(data.ingredients)) {
          tags = data.ingredients;
        } else if (typeof data.ingredients === 'string') {
          tags = data.ingredients.split(/[、,，\s]+/);
        }
        const tagsHtml = tags.filter(Boolean).map(t => `<span class='tag'>${t}</span>`).join('');
        document.getElementById("ingredientsTags").innerHTML = tagsHtml;
        // 物语字段兼容
        document.getElementById("poemCard").textContent = data.物语 || data.poem || '';
        // 2. 用配料内容生成图片，ingredients转为字符串
        const ingredientsStr = Array.isArray(data.ingredients) ? data.ingredients.join('、') : data.ingredients;
        const imgResp = await fetch('/api/ai-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ingredients: ingredientsStr, name: data.name })
        });
        const imgData = await imgResp.json();
        if (imgData.url) {
          imgEl.onload = function() {
            imgEl.style.display = '';
            imgError.style.display = 'none';
          };
          imgEl.onerror = function() {
            imgEl.style.display = 'none';
            imgError.style.display = 'flex';
          };
          imgEl.src = imgData.url;
        } else {
          imgEl.style.display = 'none';
          imgError.style.display = 'flex';
        }
      } catch {
        imgEl.style.display = 'none';
        imgError.style.display = 'flex';
        alert("生成失败，请重试！");
      }
      this.disabled = false;
      this.textContent = "换一款";
    };
    // 收藏按钮事件
    document.getElementById('favoriteBtn').onclick = function() {
      alert('已收藏！');
    };
    // 分享按钮事件
    document.getElementById('shareBtn').onclick = function() {
      var ua = navigator.userAgent.toLowerCase();
      if (ua.indexOf('micromessenger') !== -1) {
        alert('请点击右上角菜单进行分享');
      } else if (navigator.share) {
        navigator.share({
          title: '每日蔬果 Vitalcup',
          text: '今日蔬果卡片，健康又美味！',
          url: window.location.href
        });
      } else {
        alert('请用微信扫码或使用浏览器自带分享功能');
      }
    };

    // ========== 登录/注册弹窗逻辑 ==========
    const authModal = document.getElementById('auth-modal');
    const authForm = document.getElementById('authForm');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const authTip = document.getElementById('authTip');
    const authTitle = document.getElementById('authTitle');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin = document.getElementById('switchToLogin');
    let isLoginMode = true;

    function showAuthModal(show) {
      authModal.style.display = show ? 'flex' : 'none';
    }
    function setAuthMode(login) {
      isLoginMode = login;
      authTitle.textContent = login ? '邮箱登录' : '邮箱注册';
      authSubmitBtn.textContent = login ? '登录' : '注册';
      switchToRegister.style.display = login ? '' : 'none';
      switchToLogin.style.display = login ? 'none' : '';
      authTip.textContent = '';
      authForm.reset();
    }
    switchToRegister.onclick = () => setAuthMode(false);
    switchToLogin.onclick = () => setAuthMode(true);

    // 登录/注册表单提交
    authForm.onsubmit = async function(e) {
      e.preventDefault();
      const email = authEmail.value.trim();
      const password = authPassword.value;
      authSubmitBtn.disabled = true;
      authTip.textContent = isLoginMode ? '登录中...' : '注册中...';
      try {
        if (isLoginMode) {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          authTip.style.color = '#3BA769';
          authTip.textContent = '登录成功！';
          setTimeout(() => showAuthModal(false), 600);
        } else {
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          authTip.style.color = '#3BA769';
          authTip.textContent = '注册成功，请查收邮箱验证邮件！';
          setTimeout(() => setAuthMode(true), 1200);
        }
      } catch (err) {
        authTip.style.color = '#e57373';
        authTip.textContent = err.message || '操作失败';
      }
      authSubmitBtn.disabled = false;
    };
    // 检查登录状态
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        showAuthModal(true);
        setAuthMode(true);
      } else {
        showAuthModal(false);
      }
    }
    checkAuth();
    // 登录状态变化监听
    supabase.auth.onAuthStateChange((event, session) => {
      if (session && session.user) {
        showAuthModal(false);
      }
    });
  </script>
</body>
</html>
