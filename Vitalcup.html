<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitalcup 每日蔬果</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@700&family=Montserrat:ital,wght@1,400;1,700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon/fonts/remixicon.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #f6fbf7;
      font-family: 'Noto Sans SC', 'Montserrat', Arial, sans-serif;
      color: #222;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .navbar {
      width: 100vw;
      max-width: 480px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 18px 0 18px;
      background: transparent;
      box-sizing: border-box;
    }
    .nav-left {
      display: flex;
      align-items: center;
    }
    .logo {
      width: 36px;
      height: 36px;
      margin-right: 10px;
      border-radius: 50%;
      object-fit: cover;
    }
    .title {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .title-cn {
      font-family: 'Noto Sans SC', sans-serif;
      font-size: 1.18rem;
      font-weight: bold;
      color: #222;
      letter-spacing: 1px;
    }
    .title-en {
      font-family: 'Montserrat', sans-serif;
      font-size: 0.86rem;
      color: #222;
      letter-spacing: 1px;
      margin-top: 2px;
      font-style: normal;
    }
    .nav-right {
      display: flex;
      gap: 12px;
    }
    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      color: #3BA769;
      box-shadow: 0 2px 8px rgba(137,201,151,0.08);
      cursor: pointer;
      transition: background 0.2s;
    }
    .icon-btn:active { background: #eaf6ef; }
    .main-content {
      width: 100vw;
      max-width: 480px;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 8px;
      margin-bottom: 80px;
    }
    .main-title {
      font-size: 1.6rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #222;
      margin-top: 8px;
      margin-bottom: 4px;
      letter-spacing: 2px;
    }
    .main-subtitle {
      font-size: 1.02rem;
      color: #49505a;
      margin-bottom: 18px;
      letter-spacing: 1px;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: 300;
    }
    .juice-card {
      width: 94vw;
      max-width: 420px;
      background: #fff;
      border-radius: 24px;
      box-shadow: 0 4px 32px rgba(137,201,151,0.10);
      padding: 0 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 18px;
      border: 1.5px solid #e0f2f1;
    }
    .juice-img-wrap {
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 0;
      margin-bottom: 18px;
      padding: 0;
    }
    .juice-img-wrap img {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 18px 18px 0 0;
      object-fit: cover;
      background: #f1f8e9;
      border: 3px solid #e0f2f1;
      box-shadow: 0 4px 24px rgba(60,120,80,0.10);
      display: block;
    }
    .img-labels {
      position: absolute;
      top: 10px;
      left: 18px;
      display: flex;
      gap: 8px;
      z-index: 2;
    }
    .date-label, .solar-label {
      font-size: 0.86rem;
      border-radius: 12px;
      padding: 2px 10px;
      box-shadow: 0 2px 8px rgba(137,201,151,0.08);
      font-family: 'Montserrat', 'Noto Sans SC', sans-serif;
      margin-right: 4px;
    }
    .date-label {
      background: rgba(255,255,255,0.82);
      color: #49505a;
      font-style: normal;
      font-weight: normal;
    }
    .solar-label {
      background: rgba(246,190,154,0.82);
      color: #fff;
      font-weight: bold;
    }
    .juice-name-cn {
      font-size: 1.25rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #222;
      margin-top: 2px;
      margin-bottom: 2px;
      letter-spacing: 1px;
      text-align: center;
    }
    .juice-name-en {
      font-size: 1rem;
      color: #49505a;
      font-family: 'Montserrat', sans-serif;
      margin-bottom: 8px;
      text-align: center;
      font-style: italic;
    }
    .ingredients-label {
      font-size: 0.98rem;
      color: #222;
      font-family: 'Noto Sans SC', sans-serif;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      font-weight: bold;
    }
    .icon-leaf {
      font-size: 1.1rem;
      color: #3BA769;
      margin-right: 2px;
    }
    .ingredients-tags {
      display: flex;
      flex-wrap: nowrap;
      gap: 4px;
      margin-bottom: 12px;
      justify-content: center;
      overflow-x: auto;
    }
    .tag {
      background: #eaf6ef;
      color: #3BA769;
      border-radius: 10px;
      padding: 1px 7px;
      font-size: 0.82rem;
      font-family: 'Noto Sans SC', sans-serif;
      letter-spacing: 0.5px;
      font-weight: bold;
      white-space: nowrap;
      margin: 0 2px;
    }
    .poem-card {
      background: #f6fbf7;
      border-radius: 14px;
      color: #49505a;
      font-size: 0.96rem;
      font-style: normal;
      font-weight: 300;
      font-family: 'Noto Sans SC', sans-serif;
      margin: 0 18px 0 18px;
      padding: 14px 10px 10px 10px;
      text-align: center;
      line-height: 1.9;
      min-height: 48px;
      opacity: 0.95;
    }
    .footer-bar {
      width: 94vw;
      max-width: 420px;
      margin: 24px auto 0 auto;
      background: #f6fbf7;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px 18px 18px;
      box-sizing: border-box;
      z-index: 10;
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -2px 12px rgba(137,201,151,0.08);
    }
    .main-btn {
      background: #3BA769;
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 10px 38px;
      font-size: 1.15rem;
      font-family: 'Noto Serif SC', serif;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(111,207,151,0.10);
      cursor: pointer;
      transition: background 0.2s;
    }
    .main-btn:active { background: #2e7d4f; }
    .footer-icons {
      display: flex;
      gap: 16px;
    }
    .img-placeholder {
      width: 100%;
      aspect-ratio: 4/3;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #bbb;
      font-size: 1.1rem;
      background: #f5f5f5;
      border-radius: 18px 18px 0 0;
      position: absolute;
      left: 0;
      top: 0;
      z-index: 1;
    }
    #auth-modal {
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .auth-mask {
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(240,248,245,0.92);
      z-index: 1;
    }
    .auth-panel {
      position: relative;
      z-index: 2;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(137,201,151,0.13);
      padding: 32px 24px 24px 24px;
      min-width: 280px;
      max-width: 90vw;
      width: 340px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .auth-title {
      font-size: 1.3rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #3BA769;
      margin-bottom: 18px;
    }
    #authForm {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 10px;
    }
    #authForm input {
      font-size: 1rem;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0f2f1;
      outline: none;
      font-family: 'Noto Sans SC', 'Montserrat', Arial, sans-serif;
      background: #f6fbf7;
      color: #222;
      transition: border 0.2s;
    }
    #authForm input:focus {
      border: 1.5px solid #3BA769;
    }
    #authSubmitBtn {
      background: #3BA769;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 0;
      font-size: 1.08rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.2s;
    }
    #authSubmitBtn:active {
      background: #2e7d4f;
    }
    .auth-tip {
      color: #e57373;
      font-size: 0.98rem;
      min-height: 22px;
      margin-bottom: 4px;
      text-align: center;
    }
    .auth-switch {
      font-size: 0.98rem;
      color: #7bbf8e;
      margin-top: 6px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .auth-switch span {
      margin: 0 8px;
      text-decoration: underline;
    }
    /* 历史记录页面样式 */
    #historyView {
      display: none;
      width: 100vw;
      max-width: 480px;
      margin: 0 auto;
      padding: 0 0 32px 0;
      min-height: 80vh;
      background: #f4f7fa;
      border-radius: 0 0 24px 24px;
      box-sizing: border-box;
    }
    .history-header {
      text-align: center;
      margin: 32px 0 18px 0;
    }
    .history-header-icon {
      font-size: 2.2rem;
      color: #4a90e2;
      margin-bottom: 6px;
    }
    .history-header-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #49505a;
      margin-bottom: 2px;
      font-family: 'Noto Sans SC', sans-serif;
    }
    .history-header-desc {
      font-size: 1.02rem;
      color: #7b8a9a;
      margin-bottom: 18px;
    }
    .history-empty-tip {
      color: #b0b8c9;
      font-size: 1.02rem;
      margin-top: 18px;
      text-align: center;
    }
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 22px;
      align-items: center;
      width: 100%;
      margin-bottom: 18px;
    }
    .history-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 16px rgba(137,201,151,0.10);
      width: 96%;
      max-width: 400px;
      padding: 0 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1.5px solid #e0f2f1;
    }
    .history-img {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 18px 18px 0 0;
      object-fit: cover;
      background: #f1f8e9;
      border-bottom: 1.5px solid #e0f2f1;
      display: block;
    }
    .history-card-title {
      font-size: 1.12rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #222;
      margin-top: 10px;
      margin-bottom: 2px;
      text-align: center;
    }
    .history-card-en {
      font-size: 0.98rem;
      color: #49505a;
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      font-style: italic;
      margin-bottom: 6px;
    }
    .history-card-date {
      font-size: 0.92rem;
      color: #7bbf8e;
      margin-bottom: 2px;
      text-align: center;
    }
    .history-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      justify-content: center;
    }
    .history-tag {
      background: #eaf6ef;
      color: #3BA769;
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 0.92rem;
      font-family: 'Noto Sans SC', sans-serif;
      letter-spacing: 1px;
      font-weight: bold;
      white-space: nowrap;
    }
    .history-card-poem {
      background: #f6fbf7;
      border-radius: 14px;
      color: #49505a;
      font-size: 0.96rem;
      font-style: normal;
      font-weight: 300;
      font-family: 'Noto Sans SC', sans-serif;
      margin: 0 18px 0 18px;
      padding: 14px 10px 10px 10px;
      text-align: center;
      line-height: 1.9;
      min-height: 32px;
      opacity: 0.95;
    }
    /* 设置页样式 */
    #settingsView {
      display: none;
      width: 100vw;
      max-width: 480px;
      margin: 0 auto;
      min-height: 80vh;
      background: linear-gradient(180deg, #f8fafd 0%, #f6f7fa 100%);
      border-radius: 0 0 24px 24px;
      box-sizing: border-box;
      padding-bottom: 32px;
    }
    .settings-header {
      text-align: center;
      margin: 32px 0 18px 0;
    }
    .settings-header-icon {
      font-size: 2.2rem;
      color: #b96cfb;
      margin-bottom: 6px;
    }
    .settings-header-title {
      font-size: 1.25rem;
      font-weight: bold;
      color: #49505a;
      margin-bottom: 2px;
      font-family: 'Noto Sans SC', sans-serif;
    }
    .settings-header-desc {
      font-size: 1.02rem;
      color: #7b8a9a;
      margin-bottom: 18px;
    }
    .settings-user-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 12px rgba(137,201,151,0.08);
      width: 92%;
      max-width: 400px;
      margin: 0 auto 18px auto;
      padding: 18px 18px 12px 18px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .settings-user-avatar {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: #a5d6a7;
      color: #fff;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .settings-user-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .settings-user-name {
      font-size: 1.08rem;
      font-weight: bold;
      color: #222;
      font-family: 'Noto Sans SC', sans-serif;
    }
    .settings-user-desc {
      font-size: 0.98rem;
      color: #7bbf8e;
    }
    .settings-list {
      width: 92%;
      max-width: 400px;
      margin: 0 auto 18px auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .settings-item {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(137,201,151,0.06);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1.05rem;
      color: #49505a;
      cursor: pointer;
      transition: background 0.15s;
    }
    .settings-item:active {
      background: #f6fbf7;
    }
    .settings-item-label {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .settings-item-value {
      color: #7bbf8e;
      font-size: 1.02rem;
    }
    .settings-version {
      text-align: right;
      color: #b0b8c9;
      font-size: 0.98rem;
      margin: 8px 18px 0 0;
    }
    .settings-slogan {
      text-align: center;
      color: #7bbf8e;
      font-size: 1.08rem;
      margin-top: 32px;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
    }
    /* 收藏卡片 */
    #favoritesList {
      display: flex;
      flex-direction: column;
      gap: 22px;
      align-items: center;
      width: 100%;
      margin-bottom: 18px;
    }
    .favorite-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 2px 16px rgba(137,201,151,0.10);
      width: 96%;
      max-width: 400px;
      padding: 0 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1.5px solid #e0f2f1;
    }
    .favorite-img {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 18px 18px 0 0;
      object-fit: cover;
      background: #f1f8e9;
      border-bottom: 1.5px solid #e0f2f1;
      display: block;
    }
    .favorite-card-title {
      font-size: 1.12rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #222;
      margin-top: 10px;
      margin-bottom: 2px;
      text-align: center;
    }
    .favorite-card-en {
      font-size: 0.98rem;
      color: #49505a;
      font-family: 'Montserrat', sans-serif;
      text-align: center;
      font-style: italic;
      margin-bottom: 6px;
    }
    .favorite-card-date {
      font-size: 0.92rem;
      color: #7bbf8e;
      margin-bottom: 2px;
      text-align: center;
    }
    .favorite-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
      justify-content: center;
    }
    .favorite-tag {
      background: #eaf6ef;
      color: #3BA769;
      border-radius: 12px;
      padding: 2px 10px;
      font-size: 0.92rem;
      font-family: 'Noto Sans SC', sans-serif;
      letter-spacing: 1px;
      font-weight: bold;
      white-space: nowrap;
    }
    .favorite-card-poem {
      background: #f6fbf7;
      border-radius: 14px;
      color: #49505a;
      font-size: 0.96rem;
      font-style: normal;
      font-weight: 300;
      font-family: 'Noto Sans SC', sans-serif;
      margin: 0 18px 0 18px;
      padding: 14px 10px 10px 10px;
      text-align: center;
      line-height: 1.9;
      min-height: 32px;
      opacity: 0.95;
    }
    /* 反馈弹窗 */
    #feedbackModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw; height: 100vh;
      align-items: center;
      justify-content: center;
    }
    .feedback-mask {
      position: absolute;
      left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(240,248,245,0.92);
      z-index: 1;
    }
    .feedback-panel {
      position: relative;
      z-index: 2;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 32px rgba(137,201,151,0.13);
      padding: 32px 24px 24px 24px;
      min-width: 280px;
      max-width: 90vw;
      width: 340px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .feedback-title {
      font-size: 1.2rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      color: #b96cfb;
      margin-bottom: 12px;
    }
    #feedbackForm {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin-bottom: 10px;
    }
    #feedbackContent {
      font-size: 1rem;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1.5px solid #e0f2f1;
      outline: none;
      font-family: 'Noto Sans SC', 'Montserrat', Arial, sans-serif;
      background: #f6fbf7;
      color: #222;
      min-height: 60px;
      resize: vertical;
      transition: border 0.2s;
    }
    #feedbackContent:focus {
      border: 1.5px solid #b96cfb;
    }
    #feedbackSubmitBtn {
      background: #b96cfb;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 0;
      font-size: 1.08rem;
      font-family: 'Noto Sans SC', sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      cursor: pointer;
      margin-top: 6px;
      transition: background 0.2s;
    }
    #feedbackSubmitBtn:active {
      background: #8e4cc7;
    }
    .feedback-tip {
      color: #e57373;
      font-size: 0.98rem;
      min-height: 22px;
      margin-bottom: 4px;
      text-align: center;
    }
    @media (max-width: 600px) {
      .main-content, .footer-bar, .navbar { max-width: 100vw; }
      .juice-card { max-width: 99vw; }
      #historyView { max-width: 100vw; }
      .history-card { max-width: 99vw; }
      #settingsView { max-width: 100vw; }
      .settings-user-card, .settings-list, .favorite-card { max-width: 99vw; }
    }
    @media (max-width: 480px) {
      .auth-panel { width: 98vw; min-width: 0; padding: 18px 4vw 18px 4vw; }
    }
  </style>
</head>
<body>
  <div id="auth-modal" style="display:none;">
    <div class="auth-mask"></div>
    <div class="auth-panel">
      <div class="auth-title" id="authTitle">邮箱登录</div>
      <form id="authForm" autocomplete="off">
        <input type="email" id="authEmail" placeholder="邮箱地址" required />
        <input type="password" id="authPassword" placeholder="密码" required minlength="6" />
        <button type="submit" id="authSubmitBtn">登录</button>
      </form>
      <div class="auth-tip" id="authTip"></div>
      <div class="auth-switch">
        <span id="switchToRegister">没有账号？注册</span>
        <span id="switchToLogin" style="display:none;">已有账号？登录</span>
      </div>
    </div>
      </div>
  <header class="navbar">
    <div class="nav-left">
      <img src="leaf-logo.png" class="logo" alt="logo" />
      <div class="title">
        <span class="title-cn">Vitalcup</span>
        <span class="title-en">每日蔬果</span>
    </div>
  </div>
    <div class="nav-right">
      <button class="icon-btn home" title="主页"><i class="ri-home-4-line"></i></button>
      <button class="icon-btn history" title="历史记录"><i class="ri-time-line"></i></button>
      <button class="icon-btn settings" title="系统设置"><i class="ri-settings-3-line"></i></button>
    </div>
  </header>
  <main class="main-content">
    <div class="main-title">今日推荐</div>
    <div class="main-subtitle">为你精心挑选的纯净蔬果汁</div>
    <div class="juice-card">
      <div class="juice-img-wrap">
        <img id="juiceImgTag" src="vitalcup_20240710_2.jpg" alt="今日蔬果汁" />
        <div id="img-error" class="img-placeholder" style="display:none;">图片加载失败</div>
        <div class="img-labels">
          <span class="date-label" id="dateLabel">2025年7月13日 星期日</span>
          <span class="solar-label" id="solarLabel">小暑</span>
        </div>
      </div>
      <div class="juice-name-cn" id="juiceNameCn">清心露</div>
      <div class="juice-name-en" id="juiceNameEn">Morning Dew</div>
      <div class="ingredients-label"><span class="icon-leaf"><i class="ri-leaf-line"></i></span> 今日配料</div>
      <div class="ingredients-tags" id="ingredientsTags">
        <span class="tag">芒果</span>
        <span class="tag">奇异果</span>
        <span class="tag">黄瓜</span>
        <span class="tag">薄荷叶</span>
    </div>
      <div class="poem-card" id="poemCard">阳光透过玻璃，洒落在新鲜的芒果、奇异果与黄瓜之上，薄荷的清香在空气中轻轻荡漾。每一口，都是夏日清晨的第一缕微风，唤醒身体与心灵的温柔。</div>
  </div>
    <footer class="footer-bar">
      <button class="main-btn" id="changeBtn">换一款</button>
      <div class="footer-icons">
        <button class="icon-btn favorite" id="favoriteBtn" title="收藏"><i class="ri-heart-line"></i></button>
        <button class="icon-btn share" id="shareBtn" title="分享"><i class="ri-share-forward-line"></i></button>
      </div>
    </footer>
  </main>
  <div id="historyView" style="display:none;">
    <div class="history-header">
      <div class="history-header-icon"><i class="ri-calendar-line"></i></div>
      <div class="history-header-title">历史记录</div>
      <div class="history-header-desc">回顾过去的美好时光</div>
    </div>
    <div id="historyList" class="history-list"></div>
    <div id="historyEmpty" class="history-empty-tip" style="display:none;">
      暂无历史记录<br>开始你的蔬果之旅，记录每一次美好的品味体验
    </div>
  </div>
  <div id="settingsView" style="display:none;">
    <div class="settings-header">
      <div class="settings-header-icon"><i class="ri-settings-3-line"></i></div>
      <div class="settings-header-title" id="settingsTitle">设置</div>
      <div class="settings-header-desc" id="settingsDesc">个性化你的蔬果体验</div>
    </div>
    <div class="settings-user-card">
      <div class="settings-user-avatar" id="userAvatar">V</div>
      <div class="settings-user-info">
        <div class="settings-user-name" id="userName">Vitalcup 用户</div>
        <div class="settings-user-desc" id="userDesc">健康生活爱好者</div>
      </div>
    </div>
    <div class="settings-list">
      <div class="settings-item" id="langSetting">
        <div class="settings-item-label"><i class="ri-global-line"></i><span id="langLabel">语言设置</span></div>
        <div class="settings-item-value" id="langValue">简体中文</div>
      </div>
      <div class="settings-item" id="favSetting">
        <div class="settings-item-label"><i class="ri-heart-line"></i><span id="favLabel">我的收藏</span></div>
        <div class="settings-item-value" id="favCount">0个</div>
      </div>
      <div class="settings-item" id="feedbackSetting">
        <div class="settings-item-label"><i class="ri-message-3-line"></i><span id="feedbackLabel">意见反馈</span></div>
      </div>
      <div class="settings-item" id="aboutSetting" style="cursor:default;">
        <div class="settings-item-label"><i class="ri-information-line"></i><span id="aboutLabel">关于我们</span></div>
        <div class="settings-item-value" id="versionValue">v1.0.0</div>
      </div>
    </div>
    <div id="favoritesList" style="display:none;"></div>
    <div class="settings-slogan" id="settingsSlogan">Vitalcup · 每日蔬果<br>让健康成为一种优雅的生活方式</div>
  </div>
  <div id="favoritesView" style="display:none;">
    <div class="history-header">
      <div class="history-header-icon"><i class="ri-heart-3-line"></i></div>
      <div class="history-header-title">我的收藏</div>
      <div class="history-header-desc">你喜欢的蔬果都在这里</div>
    </div>
    <div id="favoritesListPage" class="history-list"></div>
    <div id="favoritesEmpty" class="history-empty-tip" style="display:none;">
      暂无收藏<br>快去发现你喜欢的蔬果吧！
    </div>
    <button id="backToSettings" class="main-btn" style="margin: 0 auto 18px auto; display:block; width:90%;">返回设置</button>
  </div>
  <div id="feedbackModal" style="display:none;">
    <div class="feedback-mask"></div>
    <div class="feedback-panel">
      <div class="feedback-title" id="feedbackTitle">意见反馈</div>
      <form id="feedbackForm" autocomplete="off">
        <textarea id="feedbackContent" placeholder="请输入您的宝贵意见..." required></textarea>
        <button type="submit" id="feedbackSubmitBtn">提交</button>
      </form>
      <div class="feedback-tip" id="feedbackTip"></div>
    </div>
  </div>
  <!-- 移除原有 toast 容器，这里不再插入 <div id="toast"> -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // ========== Toast 弹窗函数，需放在所有 JS 逻辑最前面 ==========
    function showToast(msg, duration = 1500) {
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.display = 'none';
        toast.style.position = 'fixed';
        toast.style.left = '50%';
        toast.style.bottom = '80px';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(60,120,80,0.95)';
        toast.style.color = '#fff';
        toast.style.padding = '12px 28px';
        toast.style.borderRadius = '24px';
        toast.style.fontSize = '1.08rem';
        toast.style.zIndex = '9999';
        toast.style.boxShadow = '0 2px 12px rgba(60,120,80,0.13)';
        toast.style.transition = 'opacity 0.3s';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.display = 'block';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => { toast.style.display = 'none'; }, 300);
      }, duration);
    }
    // Supabase配置
    const SUPABASE_URL = 'https://ypscwsplzpbhevzfuoma.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlwc2N3c3BsenBiaGV2emZ1b21hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIyMzg1MjEsImV4cCI6MjA2NzgxNDUyMX0.3i-LYP5N29-QC_i9rw4U0rSkkMulBu8S2RXdLSvRd3g';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>
  <script>
    window.onload = function() {
      const hash = window.location.hash;
      if (hash.includes('error=')) {
        if (hash.includes('otp_expired')) {
          alert('邮箱验证链接已失效或已被使用，请重新注册或登录。');
        } else {
          alert('邮箱验证失败，请重试。');
        }
      } else if (hash.includes('access_token=')) {
        alert('邮箱验证成功！请返回登录页面登录。');
        // 可选：自动跳转到主页面
        // window.location.href = '/Vitalcup.html';
      }
    };
    // 统一声明全局视图变量，避免重复声明
    const mainContent = document.querySelector('.main-content');
    const historyView = document.getElementById('historyView');
    const settingsView = document.getElementById('settingsView');
    const favoritesView = document.getElementById('favoritesView');
    const favoritesListPage = document.getElementById('favoritesListPage');
    const favoritesEmpty = document.getElementById('favoritesEmpty');
    const backToSettings = document.getElementById('backToSettings');
    // 你可以在这里适配原有JS逻辑到新结构
    // 下面是主要内容动态填充和按钮事件适配
    // 假设你有AI接口和配料、物语等数据

    // 示例：动态填充内容
    function updateJuiceCard(data) {
      document.getElementById('juiceImgTag').src = data.imgUrl || 'vitalcup_20240710_2.jpg';
      document.getElementById('juiceNameCn').textContent = data.name || '清心露';
      document.getElementById('juiceNameEn').textContent = data.name_en || 'Morning Dew';
      document.getElementById('dateLabel').textContent = getTodayDateStr();
      document.getElementById('solarLabel').textContent = data.solar_term || '小暑';
      // 配料标签
      const tags = (data.ingredients || '芒果、奇异果、黄瓜、薄荷叶').split(/[、,，\s]+/);
      const tagsHtml = tags.filter(Boolean).map(t => `<span class="tag">${t}</span>`).join('');
      document.getElementById('ingredientsTags').innerHTML = tagsHtml;
      document.getElementById('poemCard').textContent = data.poem || '';
    }

    // 获取今天日期字符串（如：2025年7月13日 星期日）
    function getTodayDateStr() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + 1;
      const d = now.getDate();
      const weekArr = ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'];
      const week = weekArr[now.getDay()];
      return `${y}年${m}月${d}日 ${week}`;
    }
    // 页面加载时自动设置日期
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('dateLabel').textContent = getTodayDateStr();
    });

    // ========== 历史记录功能 ==========
    const historyList = document.getElementById('historyList');
    const historyEmpty = document.getElementById('historyEmpty');
    // 顶部历史按钮点击事件
    document.querySelector('.history').onclick = function() {
      mainContent.style.display = 'none';
      historyView.style.display = 'block';
      loadHistory();
    };
    // 顶部首页按钮点击事件
    document.querySelector('.home').onclick = function() {
      historyView.style.display = 'none';
      mainContent.style.display = 'flex';
    };
    // 加载历史记录
    async function loadHistory() {
      historyList.innerHTML = '';
      historyEmpty.style.display = 'none';
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data, error } = await supabase
        .from('history')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });
      if (error || !data || data.length === 0) {
        historyEmpty.style.display = '';
        return;
      }
      data.forEach(item => {
        const tags = Array.isArray(item.ingredients) ? item.ingredients : (typeof item.ingredients === 'string' ? item.ingredients.split(/[、,，\s]+/) : []);
        const tagsHtml = tags.filter(Boolean).map(t => `<span class='history-tag'>${t}</span>`).join('');
        historyList.innerHTML += `
          <div class="history-card">
            <img src="${item.image_url || 'vitalcup_20240710_2.jpg'}" class="history-img" />
            <div class="history-card-title">${item.name || ''}</div>
            <div class="history-card-en">${item.name_en || ''}</div>
            <div class="history-card-date">${item.date || ''} ${item.solar_term ? '· ' + item.solar_term : ''}</div>
            <div class="history-card-tags">${tagsHtml}</div>
            <div class="history-card-poem">${item.poem || ''}</div>
          </div>
        `;
      });
    }
    // ========== 保存历史记录 ==========
    async function saveHistoryRecord(record) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { error } = await supabase
        .from('history')
        .insert([{ ...record, user_id: user.id }]);
      if (error) console.error('保存历史记录失败', error);
    }

    // ========== 每日生成次数限制 ==========
    function getTodayKey() {
      const now = new Date();
      return `vitalcup-generate-count-${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
    }
    function getTodayGenerateCount() {
      return parseInt(localStorage.getItem(getTodayKey()) || '0', 10);
    }
    function incTodayGenerateCount() {
      const key = getTodayKey();
      const count = getTodayGenerateCount() + 1;
      localStorage.setItem(key, count);
      return count;
    }

    // 换一款按钮事件（适配你的AI接口）
    document.getElementById('changeBtn').onclick = async function() {
      if (getTodayGenerateCount() >= 3) {
        showToast('今日生成次数已达上限，请明天再试~');
        return;
      }
      this.disabled = true;
      this.textContent = "生成中...";
      const imgEl = document.getElementById("juiceImgTag");
      const imgError = document.getElementById("img-error");
      imgError.style.display = 'none';
      imgEl.style.display = '';
      try {
        // 1. 获取AI生成的蔬果汁内容
        const resp = await fetch('/api/ai-juice');
        const data = await resp.json();
        // 始终用最新的name和name_en渲染
        document.getElementById("juiceNameCn").textContent = data.name || "清心露";
        document.getElementById("juiceNameEn").textContent = data.name_en || "Morning Dew";
        document.getElementById("dateLabel").textContent = getTodayDateStr();
        document.getElementById("solarLabel").textContent = data.solar_term || "小暑";
        // 配料标签兼容数组和字符串
        let tags = [];
        if (Array.isArray(data.ingredients)) {
          tags = data.ingredients;
        } else if (typeof data.ingredients === 'string') {
          tags = data.ingredients.split(/[、,，\s]+/);
        }
        const tagsHtml = tags.filter(Boolean).map(t => `<span class='tag'>${t}</span>`).join('');
        document.getElementById("ingredientsTags").innerHTML = tagsHtml;
        // 物语字段兼容
        document.getElementById("poemCard").textContent = data.物语 || data.poem || '';
        // 2. 用配料内容生成图片，ingredients转为字符串
        const ingredientsStr = Array.isArray(data.ingredients) ? data.ingredients.join('、') : data.ingredients;
        const imgResp = await fetch('/api/ai-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ingredients: ingredientsStr, name: data.name })
        });
        const imgData = await imgResp.json();
        if (imgData.url) {
          imgEl.onload = function() {
            imgEl.style.display = '';
            imgError.style.display = 'none';
          };
          imgEl.onerror = function() {
            imgEl.style.display = 'none';
            imgError.style.display = 'flex';
          };
          imgEl.src = imgData.url;
          // 保存历史记录（含图片）
          await saveHistoryRecord({
            date: data.date || getTodayDateStr(),
            solar_term: data.solar_term || '',
            name: data.name || '',
            name_en: data.name_en || '',
            ingredients: Array.isArray(data.ingredients) ? data.ingredients : (typeof data.ingredients === 'string' ? data.ingredients.split(/[、,，\s]+/) : []),
            poem: data.物语 || data.poem || '',
            image_url: imgData.url
          });
          incTodayGenerateCount();
      } else {
          imgEl.style.display = 'none';
          imgError.style.display = 'flex';
        }
      } catch {
        imgEl.style.display = 'none';
        imgError.style.display = 'flex';
        alert("生成失败，请重试！");
      }
      this.disabled = false;
      this.textContent = "换一款";
    };
    // 收藏按钮事件
    document.getElementById('favoriteBtn').onclick = function() {
      alert('已收藏！');
    };
    // 分享按钮事件
    document.getElementById('shareBtn').onclick = function() {
      var ua = navigator.userAgent.toLowerCase();
      if (ua.indexOf('micromessenger') !== -1) {
        alert('请点击右上角菜单进行分享');
      } else if (navigator.share) {
        navigator.share({
          title: '每日蔬果 Vitalcup',
          text: '今日蔬果卡片，健康又美味！',
          url: window.location.href
        });
      } else {
        alert('请用微信扫码或使用浏览器自带分享功能');
      }
    };

    // ========== 登录/注册弹窗逻辑 ==========
    const authModal = document.getElementById('auth-modal');
    const authForm = document.getElementById('authForm');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const authTip = document.getElementById('authTip');
    const authTitle = document.getElementById('authTitle');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const switchToRegister = document.getElementById('switchToRegister');
    const switchToLogin = document.getElementById('switchToLogin');
    let isLoginMode = true;

    function showAuthModal(show) {
      authModal.style.display = show ? 'flex' : 'none';
    }
    function setAuthMode(login) {
      isLoginMode = login;
      authTitle.textContent = login ? '邮箱登录' : '邮箱注册';
      authSubmitBtn.textContent = login ? '登录' : '注册';
      switchToRegister.style.display = login ? '' : 'none';
      switchToLogin.style.display = login ? 'none' : '';
      authTip.textContent = '';
      authForm.reset();
    }
    switchToRegister.onclick = () => setAuthMode(false);
    switchToLogin.onclick = () => setAuthMode(true);

    // 登录/注册表单提交
    authForm.onsubmit = async function(e) {
      e.preventDefault();
      const email = authEmail.value.trim();
      const password = authPassword.value;
      authSubmitBtn.disabled = true;
      authTip.textContent = isLoginMode ? '登录中...' : '注册中...';
      try {
        if (isLoginMode) {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          authTip.style.color = '#3BA769';
          authTip.textContent = '登录成功！';
          setTimeout(() => showAuthModal(false), 600);
        } else {
          const { data, error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          authTip.style.color = '#3BA769';
          authTip.textContent = '注册成功，请查收邮箱验证邮件！';
          setTimeout(() => setAuthMode(true), 1200);
        }
      } catch (err) {
        authTip.style.color = '#e57373';
        authTip.textContent = err.message || '操作失败';
      }
      authSubmitBtn.disabled = false;
    };
    // 检查登录状态
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        showAuthModal(true);
        setAuthMode(true);
      } else {
        showAuthModal(false);
      }
    }
    checkAuth();
    // 登录状态变化监听
    supabase.auth.onAuthStateChange((event, session) => {
      if (session && session.user) {
        showAuthModal(false);
      }
    });

    // ========== 设置页功能 ==========
    const settingsBtn = document.querySelector('.settings');
    const langSetting = document.getElementById('langSetting');
    const langValue = document.getElementById('langValue');
    const favSetting = document.getElementById('favSetting');
    const favCount = document.getElementById('favCount');
    const feedbackSetting = document.getElementById('feedbackSetting');
    const aboutSetting = document.getElementById('aboutSetting');
    const favoritesList = document.getElementById('favoritesList'); // 设置页下方的收藏（已不再使用）
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const langLabel = document.getElementById('langLabel');
    const favLabel = document.getElementById('favLabel');
    const feedbackLabel = document.getElementById('feedbackLabel');
    const aboutLabel = document.getElementById('aboutLabel');
    const versionValue = document.getElementById('versionValue');
    const settingsTitle = document.getElementById('settingsTitle');
    const settingsDesc = document.getElementById('settingsDesc');
    const settingsSlogan = document.getElementById('settingsSlogan');
    // 语言切换
    let lang = localStorage.getItem('vitalcup-lang') || 'zh';
    function setLang(l) {
      lang = l;
      localStorage.setItem('vitalcup-lang', l);
      // 文案切换
      if (l === 'en') {
        langValue.textContent = 'English';
        langLabel.textContent = 'Language';
        favLabel.textContent = 'Favorites';
        feedbackLabel.textContent = 'Feedback';
        aboutLabel.textContent = 'About';
        versionValue.textContent = 'v1.0.0';
        settingsTitle.textContent = 'Settings';
        settingsDesc.textContent = 'Personalize your juice experience';
        settingsSlogan.innerHTML = 'Vitalcup · Daily Juice<br>Let health become an elegant lifestyle';
        document.getElementById('mainTitle').textContent = 'Today\'s Recommendation';
        document.getElementById('mainSubtitle').textContent = 'A pure juice carefully selected for you';
      } else {
        langValue.textContent = '简体中文';
        langLabel.textContent = '语言设置';
        favLabel.textContent = '我的收藏';
        feedbackLabel.textContent = '意见反馈';
        aboutLabel.textContent = '关于我们';
        versionValue.textContent = 'v1.0.0';
        settingsTitle.textContent = '设置';
        settingsDesc.textContent = '个性化你的蔬果体验';
        settingsSlogan.innerHTML = 'Vitalcup · 每日蔬果<br>让健康成为一种优雅的生活方式';
        document.getElementById('mainTitle').textContent = '今日推荐';
        document.getElementById('mainSubtitle').textContent = '为你精心挑选的纯净蔬果汁';
      }
    }
    // 先给主副标题加 id，确保 setLang 时能找到
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelector('.main-title').id = 'mainTitle';
      document.querySelector('.main-subtitle').id = 'mainSubtitle';
      // 语言切换
      let lang = localStorage.getItem('vitalcup-lang') || 'zh';
      setLang(lang);
    });
    langSetting.onclick = function() {
      setLang(lang === 'zh' ? 'en' : 'zh');
    };
    // 设置页切换
    settingsBtn.onclick = function() {
      mainContent.style.display = 'none';
      historyView.style.display = 'none';
      settingsView.style.display = 'block';
      loadUserInfo();
      loadFavorites();
    };
    // 顶部首页按钮点击事件
    document.querySelector('.home').onclick = function() {
      historyView.style.display = 'none';
      mainContent.style.display = 'flex';
      settingsView.style.display = 'none';
    };
    // 顶部历史按钮点击事件
    document.querySelector('.history').onclick = function() {
      mainContent.style.display = 'none';
      historyView.style.display = 'block';
      settingsView.style.display = 'none';
      loadHistory();
    };
    // 用户信息
    async function loadUserInfo() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      userName.textContent = user.email || 'Vitalcup 用户';
      userAvatar.textContent = user.email ? user.email[0].toUpperCase() : 'V';
    }
    // 收藏功能 - 设置页点击后切换到收藏独立页面
    favSetting.onclick = function() {
      mainContent.style.display = 'none';
      historyView.style.display = 'none';
      settingsView.style.display = 'none';
      favoritesView.style.display = 'block';
      loadFavoritesPage();
    };
    backToSettings.onclick = function() {
      favoritesView.style.display = 'none';
      settingsView.style.display = 'block';
    };
    async function loadFavoritesPage() {
      favoritesListPage.innerHTML = '';
      favoritesEmpty.style.display = 'none';
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data, error } = await supabase
        .from('favorites')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });
      if (error || !data || data.length === 0) {
        favoritesEmpty.style.display = '';
        return;
      }
      data.forEach(item => {
        const tags = Array.isArray(item.ingredients) ? item.ingredients : (typeof item.ingredients === 'string' ? item.ingredients.split(/[、,，\s]+/) : []);
        const tagsHtml = tags.filter(Boolean).map(t => `<span class='favorite-tag'>${t}</span>`).join('');
        favoritesListPage.innerHTML += `
          <div class="favorite-card">
            <img src="${item.image_url || 'vitalcup_20240710_2.jpg'}" class="favorite-img" />
            <div class="favorite-card-title">${item.name || ''}</div>
            <div class="favorite-card-en">${item.name_en || ''}</div>
            <div class="favorite-card-date">${item.date || ''} ${item.solar_term ? '· ' + item.solar_term : ''}</div>
            <div class="favorite-card-tags">${tagsHtml}</div>
            <div class="favorite-card-poem">${item.poem || ''}</div>
          </div>
        `;
      });
    }
    // 设置页下方的收藏计数（保留）
    async function loadFavorites() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      const { data, error } = await supabase
        .from('favorites')
        .select('id')
        .eq('user_id', user.id);
      if (error || !data || data.length === 0) {
        favCount.textContent = '0个';
        return;
      }
      favCount.textContent = data.length + '个';
    }
    // 收藏按钮事件（首页右下角）
    document.getElementById('favoriteBtn').onclick = async function() {
      const btn = this;
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { showToast('请先登录'); return; }
      const name = document.getElementById('juiceNameCn').textContent;
      const name_en = document.getElementById('juiceNameEn').textContent;
      const date = document.getElementById('dateLabel').textContent;
      const solar_term = document.getElementById('solarLabel').textContent;
      const poem = document.getElementById('poemCard').textContent;
      const imgUrl = document.getElementById('juiceImgTag').src;
      const tags = Array.from(document.getElementById('ingredientsTags').querySelectorAll('.tag')).map(t=>t.textContent);
      const juice_id = name + '_' + date;
      const { data: favs } = await supabase
        .from('favorites')
        .select('id')
        .eq('user_id', user.id)
        .eq('juice_id', juice_id);
      if (favs && favs.length > 0) {
        showToast('已收藏过该果汁');
        // 立即本地切换为红色实心
        btn.innerHTML = '<i class="ri-heart-fill"></i>';
        btn.style.color = '#e74c3c';
        btn.disabled = true;
        updateFavoriteBtn();
        return;
      }
      const { error } = await supabase
        .from('favorites')
        .insert([{ user_id: user.id, juice_id, name, name_en, date, solar_term, poem, image_url: imgUrl, ingredients: tags }]);
      if (error) {
        showToast('收藏失败');
      } else {
        showToast('收藏成功');
        // 立即本地切换为红色实心
        btn.innerHTML = '<i class="ri-heart-fill"></i>';
        btn.style.color = '#e74c3c';
        btn.disabled = true;
        loadFavorites();
        // 稍后再查数据库，确保状态同步
        setTimeout(updateFavoriteBtn, 500);
      }
    };
    // 首页收藏按钮变红，且不可重复收藏
    async function updateFavoriteBtn() {
      const btn = document.getElementById('favoriteBtn');
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        btn.innerHTML = '<i class="ri-heart-line"></i>';
        btn.style.color = '';
        btn.disabled = false;
        return;
      }
      const name = document.getElementById('juiceNameCn').textContent;
      const date = document.getElementById('dateLabel').textContent;
      const juice_id = name + '_' + date;
      const { data: favs } = await supabase
        .from('favorites')
        .select('id')
        .eq('user_id', user.id)
        .eq('juice_id', juice_id);
      if (favs && favs.length > 0) {
        btn.innerHTML = '<i class="ri-heart-fill"></i>';
        btn.style.color = '#e74c3c';
        btn.disabled = true;
      } else {
        btn.innerHTML = '<i class="ri-heart-line"></i>';
        btn.style.color = '';
        btn.disabled = false;
      }
    }
    // 每次果汁卡片内容变化后调用
    function afterJuiceCardUpdate() {
      updateFavoriteBtn();
    }
    // 在 updateJuiceCard、换一款等地方调用 afterJuiceCardUpdate
    // 修改 updateJuiceCard 函数
    const oldUpdateJuiceCard = updateJuiceCard;
    updateJuiceCard = function(data) {
      oldUpdateJuiceCard(data);
      afterJuiceCardUpdate();
    };
    // 换一款按钮事件后也调用
    const oldChangeBtnClick = document.getElementById('changeBtn').onclick;
    document.getElementById('changeBtn').onclick = async function() {
      if (oldChangeBtnClick) await oldChangeBtnClick.apply(this, arguments);
      afterJuiceCardUpdate();
    };
    // 页面初始也调用
    document.addEventListener('DOMContentLoaded', afterJuiceCardUpdate);

    // ========== 自动生成首页果蔬汁内容并保存历史 ==========
    async function generateAndRenderJuice(showToastOnSuccess = false) {
      if (getTodayGenerateCount() >= 3) {
        showToast('今日生成次数已达上限，请明天再试~');
        return;
      }
      try {
        const resp = await fetch('/api/ai-juice');
        const data = await resp.json();
        const ingredientsStr = Array.isArray(data.ingredients) ? data.ingredients.join('、') : data.ingredients;
        const imgResp = await fetch('/api/ai-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ingredients: ingredientsStr, name: data.name })
        });
        const imgData = await imgResp.json();
        updateJuiceCard({
          ...data,
          imgUrl: imgData.url
        });
        await saveHistoryRecord({
          date: data.date || getTodayDateStr(),
          solar_term: data.solar_term || '',
          name: data.name || '',
          name_en: data.name_en || '',
          ingredients: Array.isArray(data.ingredients) ? data.ingredients : (typeof data.ingredients === 'string' ? data.ingredients.split(/[、,，\s]+/) : []),
          poem: data.物语 || data.poem || '',
          image_url: imgData.url
        });
        incTodayGenerateCount();
        if (showToastOnSuccess) showToast('新的一天，已为你推荐新果蔬汁！');
      } catch (e) {
        showToast('自动更新失败，请刷新页面');
      }
    }

    // ========== 页面加载时自动生成首页内容 ==========
    let lastDateStr = getTodayDateStr();
    // ========== 每天跨天自动刷新内容 ==========
    setInterval(async function() {
      const nowDateStr = getTodayDateStr();
      if (nowDateStr !== lastDateStr) {
        lastDateStr = nowDateStr;
        await generateAndRenderJuice(true);
        document.getElementById('dateLabel').textContent = nowDateStr;
      }
    }, 60 * 1000); // 每分钟检测一次

    // ========== 反馈弹窗逻辑 ==========
    const feedbackModal = document.getElementById('feedbackModal');
    const feedbackForm = document.getElementById('feedbackForm');
    const feedbackContent = document.getElementById('feedbackContent');
    const feedbackTip = document.getElementById('feedbackTip');
    const feedbackTitle = document.getElementById('feedbackTitle');
    const feedbackSubmitBtn = document.getElementById('feedbackSubmitBtn');

    function showFeedbackModal(show) {
      feedbackModal.style.display = show ? 'flex' : 'none';
    }

    feedbackForm.onsubmit = async function(e) {
      e.preventDefault();
      const content = feedbackContent.value.trim();
      feedbackSubmitBtn.disabled = true;
      feedbackTip.textContent = '提交中...';
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const { data, error } = await supabase
          .from('feedback')
          .insert([{ user_id: user?.id, content, created_at: new Date().toISOString() }]);
        if (error) throw error;
        feedbackTip.style.color = '#3BA769';
        feedbackTip.textContent = '反馈提交成功！';
        setTimeout(() => showFeedbackModal(false), 1500);
        feedbackContent.value = '';
      } catch (err) {
        feedbackTip.style.color = '#e57373';
        feedbackTip.textContent = err.message || '提交失败';
      }
      feedbackSubmitBtn.disabled = false;
    };

    feedbackSetting.onclick = function() {
      document.getElementById('feedbackModal').style.display = 'flex';
    };
  </script>
</body>
</html>
